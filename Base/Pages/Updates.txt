import { useState } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { base44 } from "@/api/base44Client";
import { Link } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { Card } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { ArrowLeft, Plus, Upload, RefreshCw, Check, Clock, AlertCircle } from "lucide-react";
import { cn } from "@/lib/utils";
import UpdateCard from "@/components/updates/UpdateCard";

export default function Updates() {
  const [selectedRobotId, setSelectedRobotId] = useState("");
  const [filterStatus, setFilterStatus] = useState("all");
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const [newUpdate, setNewUpdate] = useState({
    update_type: "firmware",
    version_to: "",
    notes: ""
  });

  const queryClient = useQueryClient();

  const { data: robots } = useQuery({
    queryKey: ['robots'],
    queryFn: () => base44.entities.Robot.list()
  });

  const { data: updates, isLoading } = useQuery({
    queryKey: ['updates', selectedRobotId, filterStatus],
    queryFn: async () => {
      let query = {};
      if (selectedRobotId) query.robot_id = selectedRobotId;
      if (filterStatus !== 'all') query.status = filterStatus;
      
      return Object.keys(query).length > 0
        ? base44.entities.UpdateLog.filter(query, '-created_date')
        : base44.entities.UpdateLog.list('-created_date');
    }
  });

  const createUpdateMutation = useMutation({
    mutationFn: (data) => base44.entities.UpdateLog.create(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['updates'] });
      setIsDialogOpen(false);
      setNewUpdate({ update_type: "firmware", version_to: "", notes: "" });
    }
  });

  const handleCreateUpdate = () => {
    const robot = robots?.find(r => r.id === selectedRobotId);
    createUpdateMutation.mutate({
      ...newUpdate,
      robot_id: selectedRobotId,
      version_from: robot?.firmware_version || "1.0.0",
      status: "pending",
      progress: 0
    });
  };

  const pendingCount = updates?.filter(u => u.status === 'pending').length || 0;
  const inProgressCount = updates?.filter(u => u.status === 'in_progress').length || 0;
  const completedCount = updates?.filter(u => u.status === 'completed').length || 0;
  const failedCount = updates?.filter(u => u.status === 'failed').length || 0;

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-indigo-50/30 to-slate-100 p-4 md:p-6">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
          <div className="flex items-center gap-4">
            <Link to={createPageUrl("Dashboard")}>
              <Button variant="ghost" size="icon">
                <ArrowLeft className="w-5 h-5" />
              </Button>
            </Link>
            <div>
              <h1 className="text-2xl font-bold text-slate-800">Remote Updates</h1>
              <p className="text-slate-500 text-sm">Manage firmware and software updates</p>
            </div>
          </div>
          
          <div className="flex items-center gap-3">
            <Select value={selectedRobotId} onValueChange={setSelectedRobotId}>
              <SelectTrigger className="w-48">
                <SelectValue placeholder="All Robots" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value={null}>All Robots</SelectItem>
                {robots?.map(robot => (
                  <SelectItem key={robot.id} value={robot.id}>
                    {robot.name}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>

            <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
              <DialogTrigger asChild>
                <Button className="bg-indigo-600 hover:bg-indigo-700" disabled={!selectedRobotId}>
                  <Plus className="w-4 h-4 mr-2" />
                  New Update
                </Button>
              </DialogTrigger>
              <DialogContent>
                <DialogHeader>
                  <DialogTitle>Schedule New Update</DialogTitle>
                </DialogHeader>
                <div className="space-y-4 mt-4">
                  <div>
                    <Label>Update Type</Label>
                    <Select 
                      value={newUpdate.update_type} 
                      onValueChange={(v) => setNewUpdate({...newUpdate, update_type: v})}
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="firmware">Firmware</SelectItem>
                        <SelectItem value="software">Software</SelectItem>
                        <SelectItem value="calibration">Calibration</SelectItem>
                        <SelectItem value="config">Configuration</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                  <div>
                    <Label>Target Version</Label>
                    <Input 
                      placeholder="e.g. 2.1.0"
                      value={newUpdate.version_to}
                      onChange={(e) => setNewUpdate({...newUpdate, version_to: e.target.value})}
                    />
                  </div>
                  <div>
                    <Label>Notes</Label>
                    <Textarea 
                      placeholder="Update notes..."
                      value={newUpdate.notes}
                      onChange={(e) => setNewUpdate({...newUpdate, notes: e.target.value})}
                    />
                  </div>
                  <Button 
                    className="w-full bg-indigo-600 hover:bg-indigo-700"
                    onClick={handleCreateUpdate}
                    disabled={!newUpdate.version_to || createUpdateMutation.isPending}
                  >
                    <Upload className="w-4 h-4 mr-2" />
                    Schedule Update
                  </Button>
                </div>
              </DialogContent>
            </Dialog>
          </div>
        </div>

        {/* Status Overview */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <Card 
            className={cn(
              "p-4 border-0 cursor-pointer transition-all",
              filterStatus === 'pending' ? "bg-amber-50 ring-2 ring-amber-300" : "bg-white/80 hover:bg-amber-50/50"
            )}
            onClick={() => setFilterStatus(filterStatus === 'pending' ? 'all' : 'pending')}
          >
            <div className="flex items-center gap-3">
              <div className="p-2 rounded-lg bg-amber-100">
                <Clock className="w-5 h-5 text-amber-600" />
              </div>
              <div>
                <p className="text-2xl font-bold text-slate-800">{pendingCount}</p>
                <p className="text-xs text-slate-500">Pending</p>
              </div>
            </div>
          </Card>
          
          <Card 
            className={cn(
              "p-4 border-0 cursor-pointer transition-all",
              filterStatus === 'in_progress' ? "bg-blue-50 ring-2 ring-blue-300" : "bg-white/80 hover:bg-blue-50/50"
            )}
            onClick={() => setFilterStatus(filterStatus === 'in_progress' ? 'all' : 'in_progress')}
          >
            <div className="flex items-center gap-3">
              <div className="p-2 rounded-lg bg-blue-100">
                <RefreshCw className="w-5 h-5 text-blue-600 animate-spin" />
              </div>
              <div>
                <p className="text-2xl font-bold text-slate-800">{inProgressCount}</p>
                <p className="text-xs text-slate-500">In Progress</p>
              </div>
            </div>
          </Card>
          
          <Card 
            className={cn(
              "p-4 border-0 cursor-pointer transition-all",
              filterStatus === 'completed' ? "bg-emerald-50 ring-2 ring-emerald-300" : "bg-white/80 hover:bg-emerald-50/50"
            )}
            onClick={() => setFilterStatus(filterStatus === 'completed' ? 'all' : 'completed')}
          >
            <div className="flex items-center gap-3">
              <div className="p-2 rounded-lg bg-emerald-100">
                <Check className="w-5 h-5 text-emerald-600" />
              </div>
              <div>
                <p className="text-2xl font-bold text-slate-800">{completedCount}</p>
                <p className="text-xs text-slate-500">Completed</p>
              </div>
            </div>
          </Card>
          
          <Card 
            className={cn(
              "p-4 border-0 cursor-pointer transition-all",
              filterStatus === 'failed' ? "bg-red-50 ring-2 ring-red-300" : "bg-white/80 hover:bg-red-50/50"
            )}
            onClick={() => setFilterStatus(filterStatus === 'failed' ? 'all' : 'failed')}
          >
            <div className="flex items-center gap-3">
              <div className="p-2 rounded-lg bg-red-100">
                <AlertCircle className="w-5 h-5 text-red-600" />
              </div>
              <div>
                <p className="text-2xl font-bold text-slate-800">{failedCount}</p>
                <p className="text-xs text-slate-500">Failed</p>
              </div>
            </div>
          </Card>
        </div>

        {/* Updates List */}
        <div className="mb-4 flex items-center justify-between">
          <h2 className="text-lg font-semibold text-slate-800">
            Update History
            {filterStatus !== 'all' && (
              <Badge variant="outline" className="ml-2 text-xs">
                {filterStatus.replace('_', ' ')}
              </Badge>
            )}
          </h2>
          {filterStatus !== 'all' && (
            <Button variant="ghost" size="sm" onClick={() => setFilterStatus('all')}>
              Clear Filter
            </Button>
          )}
        </div>

        {updates?.length > 0 ? (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {updates.map((update) => {
              const robot = robots?.find(r => r.id === update.robot_id);
              return (
                <UpdateCard 
                  key={update.id} 
                  update={{...update, robotName: robot?.name}}
                />
              );
            })}
          </div>
        ) : (
          <Card className="p-12 border-0 bg-white/80 text-center">
            <RefreshCw className="w-12 h-12 mx-auto text-slate-300 mb-3" />
            <p className="text-slate-500">No updates found</p>
            <p className="text-sm text-slate-400 mt-1">
              {selectedRobotId ? "Schedule an update for this robot" : "Select a robot to schedule updates"}
            </p>
          </Card>
        )}
      </div>
    </div>
  );
}